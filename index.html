<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AR Navigator — A-Frame GPS demo</title>
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  <!-- gps-entity-place helper -->
  <script src="https://unpkg.com/aframe-gps-entity-place@1.8.0/dist/aframe-gps-entity-place.min.js"></script>
  <style>
    body, html { margin:0; height:100%; font-family:Arial,Helvetica,sans-serif }
    #ui { position: absolute; left:12px; top:12px; z-index:100; background:rgba(255,255,255,0.9); padding:12px; border-radius:8px; width:320px; }
    #arwrap { position: absolute; inset:0; }
    button,input,select { display:block; width:100%; margin-top:8px; padding:8px; font-size:14px }
  </style>
</head>
<body>
  <div id="ui">
    <h3>AR Navigator (GPS)</h3>
    <small>Enter start lat/lng or scan a QR with JSON {"lat":..., "lng":...}</small>
    <input id="startLat" placeholder="Start latitude (e.g. 37.7749)" />
    <input id="startLng" placeholder="Start longitude (e.g. -122.4194)" />
    <button id="setStart">Set Start</button>

    <label style="margin-top:8px">Choose destination</label>
    <select id="destSelect">
      <option value="">-- pick --</option>
      <option data-lat="37.7749" data-lng="-122.4194">Lab A (sample)</option>
      <option data-lat="37.7755" data-lng="-122.4180">Lab B (sample)</option>
      <option data-lat="37.7765" data-lng="-122.4170">Lab C (sample)</option>
    </select>

    <button id="startAR">Open AR View</button>
    <div id="info" style="margin-top:8px;color:#333">Distance: —</div>
  </div>

  <!-- A-Frame / AR area -->
  <div id="arwrap">
    <a-scene embedded vr-mode-ui="enabled: false" renderer="logarithmicDepthBuffer: true" arjs="sourceType: webcam; debugUIEnabled: false;">
      <!-- camera-controlled by AR.js; we will place a gps-entity-place for the destination -->
      <a-entity camera gps-camera rotation-reader></a-entity>

      <!-- A 3D arrow that will be placed at the destination coords -->
      <a-box id="arrow" color="green" position="0 0 0" scale="0.5 0.5 0.5" visible="false"></a-box>

      <!-- A floating marker label -->
      <a-entity id="label" visible="false" text="value: Destination; align:center; width:4" position="0 1.2 0"></a-entity>
    </a-scene>
  </div>

  <script>
    // simple haversine
    function toRad(d){ return d * Math.PI/180; }
    function haversine(lat1,lon1,lat2,lon2){
      const R = 6371000;
      const dLat = toRad(lat2-lat1); const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    let start = null;
    document.getElementById('setStart').onclick = () => {
      const lat = parseFloat(document.getElementById('startLat').value);
      const lng = parseFloat(document.getElementById('startLng').value);
      if (isNaN(lat) || isNaN(lng)) return alert('Enter valid coordinates');
      start = {lat, lng};
      document.getElementById('info').innerText = `Start set: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
    };

    // open AR view and place GPS marker
    document.getElementById('startAR').onclick = async () => {
      const sel = document.getElementById('destSelect').selectedOptions[0];
      if(!sel || !sel.value) return alert('Choose a destination');
      const destLat = parseFloat(sel.getAttribute('data-lat'));
      const destLng = parseFloat(sel.getAttribute('data-lng'));
      // show arrow in scene at coordinates using gps-entity-place
      const arrow = document.getElementById('arrow');
      const label = document.getElementById('label');

      // make arrow into a gps entity dynamically
      arrow.setAttribute('gps-entity-place', `latitude: ${destLat}; longitude: ${destLng};`);
      arrow.setAttribute('visible', 'true');

      label.setAttribute('gps-entity-place', `latitude: ${destLat}; longitude: ${destLng};`);
      label.setAttribute('visible','true');

      // start a periodic distance/heading update using geolocation
      if(navigator.geolocation){
        navigator.geolocation.watchPosition(pos => {
          const curLat = pos.coords.latitude, curLng = pos.coords.longitude;
          const d = haversine(curLat, curLng, destLat, destLng);
          document.getElementById('info').innerText = (d>1000? (d/1000).toFixed(2)+' km' : Math.round(d)+' m');

          // rotate arrow to face camera: compute bearing from current to dest
          const bearing = bearingBetween(curLat,curLng,destLat,destLng);
          // A-Frame rotation: set yaw to bearing (approx)
          arrow.setAttribute('rotation', `0 ${bearing} 0`);
        }, err=>{ console.warn(err); }, { enableHighAccuracy:true, maximumAge:500 });
      } else {
        alert('Geolocation not supported');
      }
    };

    // bearing
    function toDeg(r){ return r*180/Math.PI; }
    function bearingBetween(lat1, lon1, lat2, lon2){
      const phi1=toRad(lat1), phi2=toRad(lat2), dLon=toRad(lon2-lon1);
      const y = Math.sin(dLon)*Math.cos(phi2);
      const x = Math.cos(phi1)*Math.sin(phi2) - Math.sin(phi1)*Math.cos(phi2)*Math.cos(dLon);
      return (toDeg(Math.atan2(y,x))+360)%360;
    }
  </script>
</body>
</html>
